<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- ... (meta, title, style - pas de changements majeurs ici, sauf peut-être pour un nouveau bouton) ... -->
    <style>
        /* ... (votre CSS existant) ... */
        .mode-controls button#reset-all-progress-btn { /* Style pour le nouveau bouton */
            background-color: #fd7e14; /* Orange, par exemple */
        }
        .mode-controls button#reset-all-progress-btn:hover {
            background-color: #e6690b;
        }
        #all-mastered-message {
            color: #28a745;
            font-weight: bold;
            padding: 20px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Flashcards Révision AMF</h1>

        <div id="review-mode-active-message" class="hidden">Mode Révision Actif (Questions incorrectes)</div>

        <div class="mode-controls">
            <button id="review-wrong-answers-btn">Réviser les erreurs (<span id="wrong-answers-count">0</span>)</button>
            <button id="reset-wrong-answers-btn">Réinitialiser la liste d'erreurs</button>
            <button id="reset-all-progress-btn">Réinitialiser Toute la Progression</button> <!-- NOUVEAU BOUTON -->
            <button id="back-to-full-quiz-btn" class="hidden">Retour au Quiz Complet</button>
        </div>

        <div id="flashcard-container">
            <div id="quiz-view">
                <!-- ... (structure du quiz-view inchangée) ... -->
            </div>
            <div id="results-view" class="hidden">
                <!-- Content will be injected by JS -->
            </div>
        </div>
        <div id="all-mastered-message" class="hidden">
            Félicitations ! Vous avez correctement répondu à toutes les questions. Vous pouvez <button onclick="resetAllProgressAndRestart()">tout réinitialiser</button> pour recommencer.
        </div> <!-- NOUVEAU MESSAGE -->


        <div id="loading-message">Chargement des questions...</div>
        <div id="no-review-questions-message" class="hidden" style="margin-top:20px; color: #007bff;">Aucune question incorrecte à réviser pour le moment.</div>
        <footer style="text-align: center; margin-top: 30px; font-size: 0.9em; color: #555;">
            Développé par Bensaoula Walid | <a href="https://www.linkedin.com/in/walid-bensaoula/" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: none;">Profil LinkedIn</a>
        </footer>
    </div>

    <script>
        // ... (variables existantes) ...
        let correctAnswerIds = []; // NOUVELLE VARIABLE
        const CORRECT_ANSWERS_STORAGE_KEY = 'amfFlashcardsCorrectAnswers'; // NOUVELLE CONSTANTE

        // ... (références aux éléments DOM existants) ...
        const resetAllProgressBtn = document.getElementById('reset-all-progress-btn'); // NOUVEL ÉLÉMENT
        const allMasteredMessageEl = document.getElementById('all-mastered-message'); // NOUVEL ÉLÉMENT


        // NOUVELLES FONCTIONS pour les réponses correctes
        function loadCorrectAnswerIds() {
            const storedCorrectAnswers = localStorage.getItem(CORRECT_ANSWERS_STORAGE_KEY);
            if (storedCorrectAnswers) {
                correctAnswerIds = JSON.parse(storedCorrectAnswers);
            } else {
                correctAnswerIds = [];
            }
        }

        function saveCorrectAnswerIds() {
            localStorage.setItem(CORRECT_ANSWERS_STORAGE_KEY, JSON.stringify(correctAnswerIds));
        }

        // Modifier loadQuestionsAndStart
        async function loadQuestionsAndStart(review = false) {
            currentQuestionIndex = 0;
            score = 0;
            questionsAnsweredThisSession = 0;

            loadingMessageEl.classList.remove('hidden');
            quizViewEl.classList.add('hidden');
            resultsViewEl.classList.add('hidden');
            noReviewQuestionsMessageEl.classList.add('hidden');
            allMasteredMessageEl.classList.add('hidden'); // Cacher le message "tout maîtrisé"
            modeControlsEl.classList.add('hidden');


            if (originalQuestions.length === 0) {
                try {
                    const response = await fetch('questions_amf.json');
                    if (!response.ok) throw new Error(`Erreur HTTP ! Statut: ${response.status}`);
                    originalQuestions = await response.json();
                    if (!originalQuestions || originalQuestions.length === 0) throw new Error("Le fichier JSON est vide ou mal formaté.");
                } catch (error) {
                    console.error("Erreur lors du chargement du fichier JSON:", error);
                    loadingMessageEl.textContent = `Erreur lors du chargement des questions: ${error.message}. Vérifiez la console et le fichier.`;
                    loadingMessageEl.classList.remove('hidden');
                    modeControlsEl.classList.remove('hidden'); // Afficher pour permettre réinitialisation
                    updateWrongAnswersUI();
                    // Ne pas cacher resetAllProgressBtn ici, l'utilisateur pourrait vouloir reset
                    return;
                }
            }
            modeControlsEl.classList.remove('hidden');

            isReviewMode = review;
            reviewModeActiveMessageEl.classList.toggle('hidden', !isReviewMode);
            backToFullQuizBtn.classList.toggle('hidden', !isReviewMode);
            reviewWrongAnswersBtn.classList.toggle('hidden', isReviewMode);
            // Les boutons de reset sont toujours visibles en dehors du quiz actif
            // resetWrongAnswersBtn.classList.toggle('hidden', isReviewMode);
            // resetAllProgressBtn.classList.toggle('hidden', isReviewMode);


            let questionsToLoad = [...originalQuestions];

            if (isReviewMode) {
                questions = questionsToLoad.filter(q => wrongAnswerIds.includes(q.id));
                if (questions.length === 0) {
                    noReviewQuestionsMessageEl.textContent = "Aucune question incorrecte à réviser pour le moment.";
                    noReviewQuestionsMessageEl.classList.remove('hidden');
                    loadingMessageEl.classList.add('hidden');
                    quizViewEl.classList.add('hidden'); // S'assurer que le quiz est caché
                    resultsViewEl.classList.add('hidden');
                    // Afficher les contrôles principaux
                    reviewWrongAnswersBtn.classList.remove('hidden');
                    resetWrongAnswersBtn.classList.remove('hidden');
                    resetAllProgressBtn.classList.remove('hidden');
                    backToFullQuizBtn.classList.add('hidden');
                    reviewModeActiveMessageEl.classList.add('hidden');
                    return;
                }
            } else { // Mode Quiz Complet
                questions = questionsToLoad.filter(q => !correctAnswerIds.includes(q.id));
                if (questions.length === 0 && originalQuestions.length > 0) { // Toutes les questions ont été maîtrisées
                    loadingMessageEl.classList.add('hidden');
                    allMasteredMessageEl.classList.remove('hidden');
                    quizViewEl.classList.add('hidden');
                    resultsViewEl.classList.add('hidden');
                    return;
                }
                shuffleArray(questions);
            }

            if (questions && questions.length > 0) {
                loadingMessageEl.classList.add('hidden');
                quizViewEl.classList.remove('hidden');
                resultsViewEl.classList.add('hidden');
                displayQuestion();
            } else if (!isReviewMode && originalQuestions.length > 0) { // Cas où questions est vide mais pas à cause de "tout maîtrisé" (devrait être rare)
                loadingMessageEl.textContent = "Aucune question à afficher pour cette session.";
                loadingMessageEl.classList.remove('hidden');
            } else if (!isReviewMode && originalQuestions.length === 0) {
                 loadingMessageEl.textContent = "Aucune question trouvée dans le fichier JSON.";
                 loadingMessageEl.classList.remove('hidden');
            }
        }

        // Modifier checkAnswer
        function checkAnswer(selectedChoice) {
            if (answeredCurrentQuestion) return;
            answeredCurrentQuestion = true;
            questionsAnsweredThisSession++;

            showAnswerButton.style.display = 'none';

            const q = questions[currentQuestionIndex];
            const correctAnswer = q.correctAnswer;
            const correctButton = document.querySelector(`.choices button[data-choice="${correctAnswer}"]`);
            const selectedButton = document.querySelector(`.choices button[data-choice="${selectedChoice}"]`);

            choiceButtons.forEach(button => button.classList.add('disabled'));

            if (selectedChoice === correctAnswer) {
                feedbackEl.textContent = "Bonne réponse !";
                feedbackEl.className = 'feedback correct-feedback';
                selectedButton.classList.add('correct');
                score++;

                if (!isReviewMode) { // Seulement en mode quiz complet
                    if (!correctAnswerIds.includes(q.id)) {
                        correctAnswerIds.push(q.id);
                        saveCorrectAnswerIds();
                    }
                    // Si elle était fausse avant et maintenant correcte, la retirer des erreurs
                    const indexInWrong = wrongAnswerIds.indexOf(q.id);
                    if (indexInWrong > -1) {
                        wrongAnswerIds.splice(indexInWrong, 1);
                        saveWrongAnswerIds();
                    }
                }
            } else { // Mauvaise réponse
                feedbackEl.textContent = `Mauvaise réponse. La bonne réponse était ${correctAnswer}.`;
                feedbackEl.className = 'feedback incorrect-feedback';
                if (selectedButton) selectedButton.classList.add('incorrect');
                if (correctButton) correctButton.classList.add('revealed-correct');

                if (!isReviewMode) {
                    if (!wrongAnswerIds.includes(q.id)) {
                        wrongAnswerIds.push(q.id);
                        saveWrongAnswerIds();
                    }
                }
            }
            updateProgressAndStats();
            if (currentQuestionIndex === questions.length - 1) {
                nextButton.textContent = isReviewMode ? "Terminer la Révision" : "Voir le score final";
            }
        }

        // Modifier revealAnswer (si "voir réponse" doit marquer comme "non maîtrisé")
        // Si vous voulez que "Voir Réponse" n'affecte pas le statut "maîtrisé" ou "erroné",
        // ne modifiez pas correctAnswerIds ou wrongAnswerIds ici.
        // Actuellement, il ajoute à wrongAnswerIds si pas en mode révision.
        // On pourrait décider que voir la réponse ne la marque pas comme correcte.
        function revealAnswer() {
            if (answeredCurrentQuestion) return;
            answeredCurrentQuestion = true;
            showAnswerButton.style.display = 'none';
            questionsAnsweredThisSession++;

            const q = questions[currentQuestionIndex];
            const correctAnswer = q.correctAnswer;
            const correctButton = document.querySelector(`.choices button[data-choice="${correctAnswer}"]`);

            if (correctButton) correctButton.classList.add('revealed-correct');
            
            feedbackEl.textContent = `La bonne réponse est ${correctAnswer}. (Compté comme incorrect pour cette session)`;
            feedbackEl.className = 'feedback incorrect-feedback';

            choiceButtons.forEach(button => button.classList.add('disabled'));

            if (!isReviewMode) {
                if (!wrongAnswerIds.includes(q.id)) {
                    wrongAnswerIds.push(q.id);
                    saveWrongAnswerIds();
                }
                // On ne la marque PAS comme correcte si on a juste vu la réponse
            }
            updateProgressAndStats();
            if (currentQuestionIndex === questions.length - 1) {
                nextButton.textContent = isReviewMode ? "Terminer la Révision" : "Voir le score final";
            }
        }


        // NOUVELLE FONCTION pour tout réinitialiser
        function resetAllProgress() {
            if (confirm("Êtes-vous sûr de vouloir réinitialiser TOUTE votre progression (bonnes et mauvaises réponses) ?")) {
                wrongAnswerIds = [];
                correctAnswerIds = [];
                saveWrongAnswerIds();
                saveCorrectAnswerIds();
                isReviewMode = false; // Sortir du mode révision si actif
                // Assurer que les éléments UI sont dans l'état initial pour un quiz complet
                reviewModeActiveMessageEl.classList.add('hidden');
                backToFullQuizBtn.classList.add('hidden');
                reviewWrongAnswersBtn.classList.remove('hidden');
                resetWrongAnswersBtn.classList.remove('hidden');
                resetAllProgressBtn.classList.remove('hidden');
                noReviewQuestionsMessageEl.classList.add('hidden');
                allMasteredMessageEl.classList.add('hidden');
                resultsViewEl.classList.add('hidden');
                quizViewEl.classList.add('hidden'); // Cacher avant de recharger
                loadQuestionsAndStart(false);
            }
        }
        // Fonction utilitaire pour le bouton dans le message "tout maîtrisé"
        function resetAllProgressAndRestart() {
            resetAllProgress(); // resetAllProgress s'occupe déjà de relancer le quiz
        }


        // Initialisation
        loadWrongAnswerIds();
        loadCorrectAnswerIds(); // CHARGER LES BONNES RÉPONSES AUSSI
        loadQuestionsAndStart(false);

        // Event listener pour le nouveau bouton
        resetAllProgressBtn.addEventListener('click', resetAllProgress);

        // ... (les autres event listeners restent inchangés) ...
        // choiceAButton.addEventListener('click', () => checkAnswer('A'));
        // ...

    </script>
</body>
</html>
